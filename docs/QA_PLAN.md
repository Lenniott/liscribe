# Liscribe QA Plan

_Generated by code analysis. Branch: `claude/test-ui-keyboard-5LJWq`_

---

## Overview

This document is the master QA plan for liscribe. The **recording screen is the source of truth** for all visual style decisions. Any other screen that deviates from its patterns needs to be brought into line.

Three broad concerns are tracked here:

1. **Style consistency** — do all screens look like the recording screen?
2. **Keyboard navigation and focus states** — do shortcuts work, and does the right thing receive focus on every screen load?
3. **Transcription progress bar** — currently missing; "Transcribing…" is shown with no progress indication.

A separate [`WORKFLOWS.md`](./WORKFLOWS.md) has step-by-step manual test checklists for every user flow.
A separate [`TRANSCRIPTION_PROGRESS_PLAN.md`](./TRANSCRIPTION_PROGRESS_PLAN.md) has the implementation plan for the progress bar.

---

## Environment Limitations

The following cannot be run in this automated environment because the runtime deps are not installed (`textual`, `sounddevice`, `faster-whisper`, etc.):

- Textual UI snapshot/screenshot tests
- End-to-end recording or transcription tests
- `pytest` (not installed; needs `pip install -e ".[dev]"`)

**All findings below are from static code analysis.** They must be verified by running the app manually. The WORKFLOWS document gives step-by-step scripts for manual verification.

To run the existing unit tests locally:

```bash
pip install -e ".[dev]"
pytest tests/ -v
```

The unit tests cover: `notes`, `recorder` (device listing), `config`, `output`. None cover the TUI screens.

---

## 1. Style Consistency Audit

### Source of truth: Recording Screen

**Container:** `#app-frame`
- `border: round $accent`
- `max-width: 100`, `max-height: 40`
- `background: $surface`

**Top bar:** solid `$accent` background, 1-line height, status left + buttons right.

**Buttons in top bar:** transparent background, no border, bold, underline on hover/focus.

**Footer bar:** solid `$surface` background, 1-line height; save button `$primary` background on left, cancel on right with spacer in between.

**Note input border:** `solid $secondary` at rest, `solid $primary` when focused.

**Waveform boxes:** `border: solid $accent`, height 3.

---

### Other Screens: Issues Found

All non-recording screens use `#home-frame` as their outer container. The CSS for `#home-frame` is defined separately from `#app-frame`, so they will look different.

#### `HomeScreen` (`screens/home.py`)

| Item | Current | Issue |
|------|---------|-------|
| Container | `#home-frame` | `padding: 2 2` vs `#app-frame`'s `padding: 0 0` — this is intentional for content screens; but check visually if it feels inconsistent |
| Buttons | `background: $primary`, `border: round $accent` via `#home-frame Button` | Recording footer buttons use `border: none` — the round borders on Home buttons will look different, which may be intentional for a menu-style screen |
| `^c Quit` | Rendered as a `Static`, not a `Button` | No keyboard focus ring, but keyboard shortcut works via `HOME_BINDINGS`. If Tab-cycling through the screen, this item is skipped (it's not focusable). **No issue for functionality, but the visual affordance is inconsistent with the other menu items which are Buttons.** |
| Focus on mount | Not explicitly set | First focusable widget (`btn-record`) will receive Textual's default focus. This is probably correct but should be verified — the `btn-record` should be highlighted on arrival. |

**Action required:** Verify visually. If `^c Quit` at the bottom looks like a regular action rather than a hint, consider making it a styled `Button` matching the others.

---

#### `TranscribingScreen` (`screens/transcribing.py`)

| Item | Current | Issue |
|------|---------|-------|
| Container | `#home-frame` | Shared with Home — looks like a menu screen rather than an activity screen |
| `#transcribing-title` | `Static("Transcribing…")` | No CSS rule — inherits `#home-frame` child text style. No `bold`, no size differentiation from the status line |
| `#transcribing-status` | `Static("Model: —")` | Same — no CSS, no `$text-muted` color |
| `#transcribing-progress` | `Static("")` | **Never updated.** This widget exists in the compose but is never written to. Intended for the progress bar. |
| `btn-back` | Disabled until done | No keyboard binding to dismiss (only mouse click or Enter after focus reaches the button). **A `Binding("escape", "back", "Back")` or similar should be added and activated when done.** |
| Focus on mount | Nothing receives focus (btn-back is disabled) | **Bug: nothing is focused when this screen loads.** User must Tab to reach btn-back after transcription finishes. |

---

#### `PreferencesHubScreen` (`screens/preferences.py`)

| Item | Current | Issue |
|------|---------|-------|
| Container | `#home-frame` | Consistent with Home — intentional menu pattern |
| Buttons | `background: $primary`, `border: round $accent` | Consistent with Home — OK |
| Focus on mount | Not set | Textual default — first button (`btn-deps`) should receive focus. Verify. |
| Back button | Uses `btn-back` calling `action_back()` | Consistent. Escape also works via `BACK_BINDINGS`. |

No major issues here. Visually it should match Home.

---

#### `TranscriptsScreen` (`screens/transcripts.py`)

| Item | Current | Issue |
|------|---------|-------|
| Container | `#home-frame` | Consistent |
| `#transcripts-list` | `ScrollableContainer` | No CSS width/height constraints — relies on Textual defaults inside `home-frame`. Might overflow or underflow visually. Needs visual check. |
| `TranscriptRow` buttons | `Button("Copy to clipboard", ...)` | Gets `#home-frame Button` style: `background: $primary`, `border: round $accent`. These render inside a scroll list — check if the full-width button style looks right in a list context |
| Focus on mount | Calls `_refresh()`, not `focus()` | Nothing explicitly focused after mount. Tab will reach the Back button or first Copy button. Verify which receives focus first. |
| `Back to Home` button | At bottom of compose | Placed after `ScrollableContainer` — correct. But keyboard order means Tab goes through every Copy button before reaching Back. For long transcript lists this is painful. **Consider adding `Escape` binding via `BACK_BINDINGS`.** `TranscriptsScreen` extends `BackScreen` so Escape should already work — this is fine. |

---

#### `PrefsWhisperScreen`, `PrefsDependenciesScreen`, `PrefsAliasScreen`, `PrefsSaveLocationScreen`

These were not read in detail. Apply the same audit: use `#home-frame`, check button styles, check focus on mount, check Escape works.

---

#### Modals

**`MicSelectScreen`:**
- Container: `#mic-select-container` with `border: round $accent` — correct
- `OptionList` receives default focus — correct, arrow keys navigate
- Escape works via `BINDINGS`

**`ConfirmCancelScreen`:**
- Container: `#cancel-confirm-container` with `border: round $accent` — correct
- `OptionList` receives default focus — correct
- `y`, `n`, Escape all bound — correct
- **Issue:** The message "Discard recording? Unsaved audio will be lost." is in a `Label`, not centered via CSS. `#cancel-confirm-message` has `text-align: center` in CSS — verify this renders centered in Textual.

---

## 2. Keyboard Navigation & Focus Audit

### Summary Table

| Screen | Initial Focus | Keyboard to navigate | Notes |
|--------|--------------|---------------------|-------|
| **HomeScreen** | `btn-record` (Textual default) | Tab cycles buttons, `^r`/`^p`/`^t`/`^c` shortcuts | `^c` is also terminal interrupt — if running outside Textual, may conflict. Inside Textual, should be fine. |
| **RecordingScreen** | `#note-input` (explicit in `on_mount`) | `^s`/`^c`/`^l`/`^o`/`^n` shortcuts; Tab cycles buttons and input | Correct — note input correctly focused on load |
| **TranscribingScreen** | **Nothing** (btn-back is disabled) | Tab to reach btn-back once enabled | **Bug: no focus on mount** |
| **PreferencesHubScreen** | `btn-deps` (Textual default) | Tab cycles buttons, Escape goes back | Check Escape is handled |
| **TranscriptsScreen** | Unknown (no explicit set) | Tab through Copy buttons, Escape goes back | Check which gets focus first |
| **MicSelectScreen** | `OptionList` (Textual default) | Arrow keys, Enter, Escape | Correct |
| **ConfirmCancelScreen** | `OptionList` (Textual default) | Arrow keys, Enter, `y`/`n`, Escape | Correct |

### Specific Issues

**BUG — TranscribingScreen has no focus on mount:**
```python
# screens/transcribing.py:47
def on_mount(self) -> None:
    self.run_worker(self._run_pipeline, exclusive=True, thread=True)
    # Missing: self.query_one("#transcribing-title", Static).focus()
    # or better: some status label that can receive focus for screen readers
```
When the screen loads, `btn-back` is disabled, so Textual has nothing to focus. The user sees the screen with nothing highlighted. After transcription completes and `btn-back` is re-enabled, the user must press Tab to reach it.

**Fix:** After transcription completes (`_update_done`), call `self.query_one("#btn-back", Button).focus()`.

---

**Home screen `^c = Quit`:**
Inside Textual's event loop this works correctly. However, it is worth noting that `ctrl+c` is historically "interrupt" and some users may instinctively press it expecting to cancel an action (not quit the app). Already acceptable — just note for user-facing docs.

---

**Tab order on Recording screen:**
The compose order is: `status-text` → `btn-speaker` → `btn-mic` → (mic-bar, waveforms are Static, not focusable) → `note-input` → `btn-footer-save` → `footer-bar-spacer` → `btn-footer-cancel`.

Tab will go: `btn-speaker` → `btn-mic` → `note-input` → `btn-footer-save` → `btn-footer-cancel` → back to `btn-speaker`.

This is reasonable. The note input gets initial focus. `^n` refocuses it at any time.

---

## 3. Transcription Progress Bar — Missing Feature

### Current State

`TranscribingScreen` has a placeholder `Static("", id="transcribing-progress")` that is never updated. The worker subprocess (`transcribe_worker.py`) calls `transcribe()` **without** an `on_progress` callback:

```python
# transcribe_worker.py:60
result = transcribe(str(wav_path), model=model, model_size=model_size)
# on_progress is not passed → no progress reporting
```

The progress callback infrastructure **already exists** in `transcriber.py` — it just isn't wired to the UI. The challenge is that the transcription runs in a **subprocess** (to avoid file-descriptor conflicts with Textual), so IPC is needed to relay progress back to the TUI.

See [`TRANSCRIPTION_PROGRESS_PLAN.md`](./TRANSCRIPTION_PROGRESS_PLAN.md) for the full implementation plan.

---

## 4. What Can Be Automated vs Manual

### Automatable (unit tests — can be done now)

These test pure logic with no UI or audio hardware needed:

| Test | File | What to test |
|------|------|-------------|
| Notes | `tests/test_notes.py` | Already exists — run it |
| Config | `tests/test_config.py` | Already exists — run it |
| Output/markdown | `tests/test_output.py` | Already exists — run it |
| Recorder devices | `tests/test_recorder.py` | Already exists — run it |
| Progress calculation | New | `_report_progress` ETA math in `transcriber.py` |
| Transcription result | New | `TranscriptionResult.word_count` |

### Automatable (Textual pilot tests — possible but complex)

Textual has a `pilot` testing API that can click buttons and press keys in a headless app. These need `textual` installed and audio hardware mocked:

| Flow | Complexity | Notes |
|------|-----------|-------|
| Home screen renders | Low | Check widgets present, check bindings |
| HomeScreen keyboard shortcuts navigate | Medium | Requires mocking `push_screen` |
| TranscribingScreen focus after done | Low | Verify `btn-back` gets focused in `_update_done` |
| RecordingScreen focus on mount | Low | Check `#note-input` is focused |
| ConfirmCancelScreen y/n/escape | Medium | Verify dismiss values |

These are not written yet — see section 5 for new test stubs to add.

### Cannot automate (requires real hardware / runtime)

| Test | Why manual only |
|------|----------------|
| Recording audio captures correctly | Needs real mic + sounddevice |
| Waveform renders | Needs running TUI |
| Speaker capture (BlackHole) | Needs macOS + BlackHole installed |
| Transcription produces correct output | Needs faster-whisper model downloaded |
| Transcription progress bar shows correctly | Needs running subprocess + TUI |
| Clipboard copy works | Needs desktop clipboard (pyperclip) |

---

## 5. Proposed New Tests

### Unit test: progress calculation (`tests/test_transcriber.py`)

```python
"""Tests for transcription progress math."""
import pytest
from unittest.mock import MagicMock, patch

def test_progress_callback_called():
    """on_progress receives values between 0.0 and 1.0."""
    from liscribe.transcriber import AVG_SEGMENT_SEC
    # Verify the math: progress = min(segment_index / total_estimated, 1.0)
    total = 10
    calls = []
    for i in range(1, total + 1):
        progress = min(i / total, 1.0)
        assert 0.0 <= progress <= 1.0
        calls.append(progress)
    assert calls[-1] == 1.0
```

### Textual pilot test: home screen bindings (`tests/test_home_screen.py`)

```python
"""Textual pilot tests for HomeScreen."""
import pytest
from textual.testing import AppTest

# These require: pip install "textual[dev]"
# and mocking of audio + push_screen

@pytest.mark.asyncio
async def test_home_renders():
    """HomeScreen should show title and all four buttons."""
    # Requires mocking LiscribeApp's screen stack and audio
    pass  # Stub — implement with pilot when deps available
```

### Textual pilot test: transcribing screen focus (`tests/test_transcribing_screen.py`)

```python
"""Transcribing screen: btn-back should receive focus after transcription."""
# Stub — implement when Textual pilot tests are wired up
pass
```

---

## 6. Issues Ranked by Priority

| # | Issue | Screen | Severity | Automatable |
|---|-------|--------|----------|-------------|
| 1 | Transcription progress bar missing | TranscribingScreen | High | Partly (unit test for IPC logic) |
| 2 | No focus on TranscribingScreen mount | TranscribingScreen | Medium | Yes (Textual pilot) |
| 3 | `btn-back` not auto-focused after transcription done | TranscribingScreen | Medium | Yes (Textual pilot) |
| 4 | `#transcribing-title` / `#transcribing-status` no CSS | TranscribingScreen | Low | No (visual) |
| 5 | Home `^c Quit` is a Static not Button | HomeScreen | Low | No (visual) |
| 6 | TranscriptsScreen no explicit focus on mount | TranscriptsScreen | Low | Yes (Textual pilot) |
| 7 | No CSS for `#transcripts-list` scroll area | TranscriptsScreen | Low | No (visual) |
| 8 | Prefs sub-screens not audited | Prefs screens | Low | No |

---

## 7. Checklist for Manual Testing Session

Use [`WORKFLOWS.md`](./WORKFLOWS.md) for the full step-by-step scripts. Quick checklist:

### Recording flow
- [ ] Launch app (`rec` or `python -m liscribe`)
- [ ] Home screen: `btn-record` has visible focus ring
- [ ] Press `^r` → Recording screen opens
- [ ] Recording screen: `#note-input` has focus ring on load
- [ ] Status bar shows `liscribe ● REC 00:00:01` incrementing
- [ ] Waveform animates
- [ ] Type a note → press Enter → note appears in list, input clears
- [ ] Press `^n` → focus returns to note input
- [ ] Press `^l` → mic select modal opens, arrow keys navigate, Escape cancels
- [ ] Press `^o` → speaker waveform toggles on/off
- [ ] Press `^s` → stops and transitions to Transcribing screen
- [ ] Transcribing screen shows model name
- [ ] (After progress bar implemented) Progress bar shows percentage
- [ ] "Done" shown, `Back to Home` becomes active and focused
- [ ] Press Enter → back to Home

### Cancel flow
- [ ] In recording, press `^c` → cancel confirm modal appears
- [ ] OptionList is focused, `n` → stays recording
- [ ] Press `^c` again → press `y` → returns to Home

### Preferences flow
- [ ] From Home, `^p` → Preferences screen, first button focused
- [ ] Tab cycles through buttons
- [ ] Escape → back to Home
- [ ] Each sub-screen opens, Escape returns to Preferences

### Transcripts flow
- [ ] After saving a transcript, go to Transcripts from Home (`^t`)
- [ ] Transcript listed, `Copy to clipboard` button visible
- [ ] Click or Enter on Copy → notification "Copied to clipboard"
- [ ] Escape or Back button → Home

### Style checks (all screens vs recording screen)
- [ ] All screens have `round $accent` border on outer container
- [ ] All screens use same accent colour
- [ ] Button focus rings look consistent across screens
- [ ] Text muted colour used consistently for secondary info
